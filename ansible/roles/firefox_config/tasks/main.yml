---
# Firefox Configuration Role - Main Tasks
# =======================================
# Deploys Firefox configuration files to the correct Windows locations

- name: "Get Firefox profile directory"
  win_shell: |
    $appDataPath = [Environment]::GetFolderPath('ApplicationData')
    $firefoxPath = Join-Path $appDataPath "Mozilla\Firefox\Profiles"
    return $firefoxPath
  register: firefox_profiles_path
  changed_when: false

- name: "Find existing Firefox profiles"
  win_find:
    paths: "{{ firefox_profiles_path.stdout | trim }}"
    file_type: directory
    patterns: "*.default*"
  register: existing_firefox_profiles
  failed_when: false

- name: "Create default Firefox profile directory if none exists"
  win_file:
    path: "{{ firefox_profiles_path.stdout | trim }}\\default-release"
    state: directory
  when: existing_firefox_profiles.files | length == 0

- name: "Set target Firefox profile directory"
  set_fact:
    firefox_target_profile: >-
      {{
        existing_firefox_profiles.files[0].path if existing_firefox_profiles.files | length > 0
        else (firefox_profiles_path.stdout | trim) + '\\default-release'
      }}

- name: "Create chrome directory for userChrome.css"
  win_file:
    path: "{{ firefox_target_profile }}\\chrome"
    state: directory

- name: "Find Firefox configuration files on controller"
  find:
    paths: "{{ firefox_config.source_directory }}"
    file_type: file
    recurse: yes
  register: firefox_config_files
  delegate_to: localhost
  when: firefox_config.copy_configs | default(true)

- name: "Copy userChrome.css to chrome directory"
  win_copy:
    src: "{{ item.path }}"
    dest: "{{ firefox_target_profile }}\\chrome\\{{ item.path | basename }}"
    backup: yes
  loop: "{{ firefox_config_files.files }}"
  when: 
    - firefox_config.copy_configs | default(true)
    - firefox_config_files.files is defined
    - item.path | basename == "userChrome.css"
  register: userchrome_copy_result

- name: "Copy other Firefox configuration files to profile root"
  win_copy:
    src: "{{ item.path }}"
    dest: "{{ firefox_target_profile }}\\{{ item.path | basename }}"
    backup: yes
  loop: "{{ firefox_config_files.files }}"
  when: 
    - firefox_config.copy_configs | default(true)
    - firefox_config_files.files is defined
    - item.path | basename != "userChrome.css"
  register: other_files_copy_result

- name: "Display Firefox configuration summary"
  debug:
    msg: |
      ü¶ä Firefox Configuration Summary:
      =================================
      Target Profile Directory: {{ firefox_target_profile }}
      Chrome Directory Created: {{ firefox_target_profile }}\\chrome
      userChrome.css Copied: {{ userchrome_copy_result.results | length if userchrome_copy_result is defined else 0 }}
      Other Files Copied: {{ other_files_copy_result.results | length if other_files_copy_result is defined else 0 }}
      
      ‚úÖ Firefox configuration deployment completed!
      
      üìù Next Steps:
      - Launch Firefox to verify configuration
      - Enable userChrome.css in about:config (toolkit.legacyUserProfileCustomizations.stylesheets = true)
      - Install Sidebery extension if not already installed
      - Restart Firefox to apply userChrome.css changes
      - Check that preferences and settings are properly applied 